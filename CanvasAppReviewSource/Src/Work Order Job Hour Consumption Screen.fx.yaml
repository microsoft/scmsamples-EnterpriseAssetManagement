"'Work Order Job Hour Consumption Screen' As screen":
    Fill: =gblAppColors.Background
    OnHidden: =false
    OnVisible: |
        =UpdateContext({varNewTimeSpent: Blank()});
        
        // should go last
        Set(
            gblPreviousScreen,
            Self
        );

    cmpHeaderWOJHCS As SubScreenHeader:
        BackButtonAccessibleLabel: =T.BackButtonAccessibleLabel
        Title: =T.AdjustTimeSpentLabel
        Width: =Parent.Width
        ZIndex: =5

    conScrollableActionsWOJHCS As groupContainer.verticalAutoLayoutContainer:
        Height: =Min(490, Parent.Height - cmpHeaderWOJHCS.Height)
        LayoutDirection: =LayoutDirection.Vertical
        LayoutMode: =LayoutMode.Auto
        Width: =Parent.Width
        Y: =Min(Parent.Height - cmpHeaderWOJHCS.Height, Parent.Height - conScrollableActionsWOJHCS.Height)
        ZIndex: =6

        conActionsWOJHCS As groupContainer.verticalAutoLayoutContainer:
            Height: |-
                =With(
                    {
                        controlHeights: [
                            conAdjustHoursSpent.Height,
                            btnConfirmTimeSpent.Height
                        ]
                    },
                    Sum(
                        controlHeights,
                        Value
                    ) + Self.PaddingTop + Self.PaddingBottom + Self.LayoutGap * CountRows(controlHeights)
                )
            LayoutAlignItems: =LayoutAlignItems.Stretch
            LayoutDirection: =LayoutDirection.Vertical
            LayoutGap: =16
            LayoutMinHeight: =100
            LayoutMinWidth: =250
            LayoutMode: =LayoutMode.Auto
            LayoutOverflowY: =LayoutOverflow.Scroll
            PaddingLeft: |-
                =// Yes, specifically 9- to simulate a padding of 16px when the card shadow is taken into account
                9
            PaddingRight: =9
            PaddingTop: =14
            Width: =Parent.Width
            X: =
            Y: =Parent.Height - Self.Height
            ZIndex: =1

            conAdjustHoursSpent As groupContainer:
                AlignInContainer: =AlignInContainer.SetByContainer
                FillPortions: =0
                Height: =conAdjustTimeSpentHorizontal.Height
                LayoutMinHeight: =100
                LayoutMinWidth: =250
                Width: =1366
                Y: =267
                ZIndex: =1

                htmCardBackgroundAdjustHours As htmlViewer:
                    DisabledBorderColor: =RGBA(56, 56, 56, 1)
                    Height: =conAdjustHoursSpent.Height
                    HtmlText: |-
                        ="<div style=""padding: 5px 8px 10px;height:100%;position:absolute;width:100%;box-sizing:border-box;""><div style=""background-color:#fff;box-shadow:0px 2px 4px rgba(0,0,0,0.14),0px 0px 2px rgba(0,0,0, 0.12);border-radius:15px;height:100%;width:100%;""></div></div>"
                    OnSelect: =
                    PaddingBottom: =0
                    PaddingLeft: =0
                    PaddingRight: =0
                    Width: =Parent.Width
                    ZIndex: =1

                conAdjustTimeSpentHorizontal As groupContainer.horizontalAutoLayoutContainer:
                    Height: =Max(conHoursSpentColumn.Height, conMinutesSpentColumn.Height) + Self.PaddingTop + Self.PaddingBottom
                    LayoutAlignItems: =LayoutAlignItems.Stretch
                    LayoutGap: =16
                    LayoutJustifyContent: =LayoutJustifyContent.Center
                    LayoutMode: =LayoutMode.Auto
                    PaddingBottom: =20
                    PaddingLeft: =20
                    PaddingRight: =20
                    PaddingTop: =24
                    Width: =Parent.Width
                    ZIndex: =4

                    conHoursSpentColumn As groupContainer.verticalAutoLayoutContainer:
                        AlignInContainer: =AlignInContainer.Center
                        FillPortions: =0
                        Height: =360
                        LayoutAlignItems: =LayoutAlignItems.Stretch
                        LayoutDirection: =LayoutDirection.Vertical
                        LayoutJustifyContent: =LayoutJustifyContent.SpaceBetween
                        LayoutMinHeight: =100
                        LayoutMinWidth: =250
                        LayoutMode: =LayoutMode.Auto
                        PaddingBottom: =2
                        PaddingLeft: =2
                        PaddingRight: =2
                        PaddingTop: =2
                        Width: =130
                        ZIndex: =1

                        conIncrementHours As groupContainer.manualLayoutContainer:
                            AlignInContainer: =AlignInContainer.Center
                            FillPortions: =0
                            Height: =btnIncrementHoursSpent.Height +10
                            LayoutMinHeight: =50
                            LayoutMinWidth: =50
                            PaddingBottom: =5
                            PaddingLeft: =5
                            PaddingRight: =5
                            PaddingTop: =5
                            Width: =btnIncrementHoursSpent.Width +10
                            ZIndex: =1

                            btnIncrementHoursSpent As button:
                                BorderColor: =gblAppStyles.Button.BorderColor
                                BorderStyle: =gblAppStyles.Button.BorderStyle
                                BorderThickness: =gblAppStyles.Button.BorderThickness
                                Color: =gblAppStyles.Button.FontColor
                                Fill: =gblAppStyles.Button.Fill
                                FocusedBorderColor: =gblAppStyles.FocusBorderColor
                                FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                                Font: |-
                                    =// don't change away from this font, it fits perfectly in the center
                                    // where other fonts do not (top or bottom gap)
                                    Font.'Open Sans'
                                Height: =100
                                HoverColor: =gblAppStyles.Button.HoverColor
                                HoverFill: =gblAppStyles.Button.HoverFill
                                OnSelect: |-
                                    =UpdateContext({ varNewTimeSpent: Coalesce(varNewTimeSpent, CurrentTimeSpent, 0) + 1 })
                                PressedColor: =gblAppStyles.Button.PressedColor
                                PressedFill: =gblAppStyles.Button.PressedFill
                                RadiusBottomLeft: =Self.RadiusTopLeft
                                RadiusBottomRight: =Self.RadiusTopLeft
                                RadiusTopLeft: =gblAppStyles.Button.BorderRadius
                                RadiusTopRight: =Self.RadiusTopLeft
                                Size: =gblAppStyles.FontSize_Special
                                Text: =""
                                Tooltip: =T.IncrementHoursAccessibleLabel
                                Width: =115
                                X: =5
                                Y: =5
                                ZIndex: =1

                            icoAddHours As icon.Add:
                                Color: =gblAppColors.Neutral
                                Icon: =Icon.Add
                                OnSelect: =Select(btnIncrementHoursSpent)
                                Width: =46
                                X: =39
                                Y: =23
                                ZIndex: =2

                        txtTimeSpentHours As text:
                            AccessibleLabel: =T.HourConsumptionAccessibleLabel
                            Align: =Align.Center
                            BorderThickness: =0
                            Default: =Trunc(Coalesce(varNewTimeSpent, CurrentTimeSpent, 0))
                            Font: =gblAppStyles.CommonFont
                            Format: =TextFormat.Number
                            Height: =80
                            LayoutMinWidth: =70
                            PaddingBottom: =0
                            PaddingLeft: =0
                            PaddingRight: =0
                            PaddingTop: =0
                            Size: =gblAppStyles.FontSize_Special
                            ZIndex: =3

                        lblHoursSpentLabel As label:
                            Align: =Align.Center
                            AlignInContainer: =AlignInContainer.Stretch
                            Font: =gblAppStyles.CommonFont
                            FontWeight: =FontWeight.Bold
                            LayoutMinWidth: =100
                            PaddingTop: =0
                            Size: =gblAppStyles.FontSize_XLarge
                            Text: =If(Abs(Value(txtTimeSpentHours.Text)) = 1, T.TimeSpentHoursSingularHeaderLabel, T.TimeSpentHoursPluralHeaderLabel)
                            VerticalAlign: =VerticalAlign.Top
                            Width: =100
                            ZIndex: =4

                        conDecrementHours As groupContainer.manualLayoutContainer:
                            AlignInContainer: =AlignInContainer.Center
                            FillPortions: =0
                            Height: =btnDecrementHoursSpent.Height +10 
                            LayoutMinHeight: =50
                            LayoutMinWidth: =50
                            PaddingBottom: =5
                            PaddingLeft: =5
                            PaddingRight: =5
                            PaddingTop: =5
                            Width: =btnDecrementHoursSpent.Width +10 
                            ZIndex: =6

                            btnDecrementHoursSpent As button:
                                BorderColor: =gblAppStyles.ButtonSecondary.BorderColor
                                BorderThickness: =gblAppStyles.ButtonSecondary.BorderThickness
                                Color: =gblAppStyles.ButtonSecondary.FontColor
                                Fill: =gblAppStyles.ButtonSecondary.Fill
                                FocusedBorderColor: =gblAppStyles.FocusBorderColor
                                FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                                Font: =btnIncrementHoursSpent.Font
                                Height: =100
                                OnSelect: |-
                                    =UpdateContext({ varNewTimeSpent: Coalesce(varNewTimeSpent, CurrentTimeSpent, 0) - 1 })
                                RadiusBottomLeft: =Self.RadiusTopLeft
                                RadiusBottomRight: =Self.RadiusTopLeft
                                RadiusTopLeft: =gblAppStyles.ButtonSecondary.BorderRadius
                                RadiusTopRight: =Self.RadiusTopLeft
                                Size: =gblAppStyles.FontSize_Special
                                Text: =""
                                Tooltip: =T.DecrementHoursAccessibleLabel
                                VerticalAlign: =VerticalAlign.Top
                                Width: =115
                                X: =5
                                Y: =5
                                ZIndex: =1

                            icoDecrementHours As icon.HorizontalLine:
                                Color: =gblAppStyles.Button.Fill
                                Height: =56
                                Icon: =Icon.HorizontalLine
                                OnSelect: =Select(btnDecrementHoursSpent)
                                Width: =30
                                X: =47
                                Y: =27
                                ZIndex: =2

                    conMinutesSpentColumn As groupContainer.verticalAutoLayoutContainer:
                        AlignInContainer: =AlignInContainer.Center
                        FillPortions: =0
                        Height: =conHoursSpentColumn.Height
                        LayoutAlignItems: =LayoutAlignItems.Stretch
                        LayoutDirection: =LayoutDirection.Vertical
                        LayoutJustifyContent: =LayoutJustifyContent.SpaceBetween
                        LayoutMinHeight: =100
                        LayoutMinWidth: =250
                        LayoutMode: =LayoutMode.Auto
                        PaddingBottom: =2
                        PaddingLeft: =2
                        PaddingRight: =2
                        PaddingTop: =2
                        Width: =conHoursSpentColumn.Width
                        ZIndex: =2

                        conIncrementMinutes As groupContainer.manualLayoutContainer:
                            AlignInContainer: =AlignInContainer.Center
                            FillPortions: =0
                            Height: =btnIncrementMinutesSpent.Height + 10
                            LayoutMinHeight: =50
                            LayoutMinWidth: =50
                            PaddingBottom: =5
                            PaddingLeft: =5
                            PaddingRight: =5
                            PaddingTop: =5
                            Width: =btnIncrementMinutesSpent.Width + 10
                            ZIndex: =1

                            btnIncrementMinutesSpent As button:
                                BorderColor: =gblAppStyles.Button.BorderColor
                                BorderThickness: =0
                                Fill: =gblAppStyles.Button.Fill
                                FocusedBorderColor: =gblAppStyles.FocusBorderColor
                                FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                                Font: =btnIncrementHoursSpent.Font
                                Height: =100
                                HoverColor: =gblAppStyles.Button.HoverColor
                                HoverFill: =gblAppStyles.Button.HoverFill
                                OnSelect: |-
                                    =With(
                                        {
                                            locHoursSpent: txtTimeSpentHours.Text,
                                            locMinutesSpent: txtTimeSpentMinutes.Text
                                        },
                                        With(
                                            {
                                                locNewMinutesSpent: locMinutesSpent - Mod(locMinutesSpent, 15) + 15
                                            },
                                            UpdateContext({varNewTimeSpent: locHoursSpent + (locNewMinutesSpent / 60)});
                                        )
                                    )
                                PressedColor: =gblAppStyles.Button.PressedColor
                                PressedFill: =gblAppStyles.Button.PressedFill
                                RadiusBottomLeft: =Self.RadiusTopLeft
                                RadiusBottomRight: =Self.RadiusTopLeft
                                RadiusTopLeft: =gblAppStyles.Button.BorderRadius
                                RadiusTopRight: =Self.RadiusTopLeft
                                Size: =gblAppStyles.FontSize_Special
                                Text: =""
                                Tooltip: =T.IncrementMinutesAccessibleLabel
                                Width: =115
                                X: =5
                                Y: =5
                                ZIndex: =1

                            icoAddMinutes As icon.Add:
                                Color: =gblAppColors.Neutral
                                Icon: =Icon.Add
                                OnSelect: =Select(btnIncrementMinutesSpent)
                                Width: =46
                                X: =39
                                Y: =23
                                ZIndex: =2

                        txtTimeSpentMinutes As text:
                            AccessibleLabel: =T.MinuteConsumptionAccessibleLabel
                            Align: =Align.Center
                            BorderThickness: =0
                            Default: |-
                                =// Do not change this to use Mod(x, 1) as the following formula has
                                // a more intuitive behavior when going in the negative direction.
                                // In the positive direction, they act the same.
                                
                                With({ locHoursSpent: Coalesce(varNewTimeSpent, CurrentTimeSpent, 0) },
                                    // the outer truncation is to avoid having decimals on the minutes
                                    Trunc((locHoursSpent - Trunc(locHoursSpent)) * 60)
                                )
                            Font: =gblAppStyles.CommonFont
                            Format: =TextFormat.Number
                            Height: =80
                            LayoutMinWidth: =70
                            PaddingBottom: =0
                            PaddingLeft: =0
                            PaddingRight: =0
                            PaddingTop: =0
                            Size: =gblAppStyles.FontSize_Special
                            Width: =70
                            ZIndex: =3

                        lblMinutesSpentLabel As label:
                            Align: =Align.Center
                            AlignInContainer: =AlignInContainer.Stretch
                            Font: =gblAppStyles.CommonFont
                            FontWeight: =FontWeight.Bold
                            LayoutMinWidth: =100
                            PaddingTop: =0
                            Size: =gblAppStyles.FontSize_XLarge
                            Text: =If(Abs(Value(txtTimeSpentMinutes.Text)) = 1, T.TimeSpentMinutesSingularHeaderLabel, T.TimeSpentMinutesPluralHeaderLabel)
                            VerticalAlign: =VerticalAlign.Top
                            Width: =100
                            ZIndex: =4

                        conDecrementMinutes As groupContainer.manualLayoutContainer:
                            AlignInContainer: =AlignInContainer.Center
                            FillPortions: =0
                            Height: =btnDecrementMinutesSpent.Height + 10
                            LayoutMinHeight: =50
                            LayoutMinWidth: =50
                            PaddingBottom: =5
                            PaddingLeft: =5
                            PaddingRight: =5
                            PaddingTop: =5
                            Width: =btnDecrementMinutesSpent.Width + 10
                            ZIndex: =6

                            btnDecrementMinutesSpent As button:
                                BorderColor: =gblAppStyles.ButtonSecondary.BorderColor
                                BorderThickness: =gblAppStyles.ButtonSecondary.BorderThickness
                                Color: =gblAppStyles.ButtonSecondary.FontColor
                                Fill: =gblAppStyles.ButtonSecondary.Fill
                                FocusedBorderColor: =gblAppStyles.FocusBorderColor
                                FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                                Font: =btnIncrementHoursSpent.Font
                                Height: =100
                                OnSelect: |-
                                    =With(
                                        {
                                            locHoursSpent: txtTimeSpentHours.Text,
                                            locMinutesSpent: txtTimeSpentMinutes.Text
                                        },
                                        With(
                                            {
                                                locNewMinutesSpent: locMinutesSpent - Mod(locMinutesSpent, 15) - 15
                                            },
                                            UpdateContext({varNewTimeSpent: locHoursSpent + (locNewMinutesSpent / 60)});
                                        )
                                    )
                                RadiusBottomLeft: =Self.RadiusTopLeft
                                RadiusBottomRight: =Self.RadiusTopLeft
                                RadiusTopLeft: =gblAppStyles.ButtonSecondary.BorderRadius
                                RadiusTopRight: =Self.RadiusTopLeft
                                Size: =gblAppStyles.FontSize_Special
                                Text: =""
                                Tooltip: =T.DecrementMinutesAccessibleLabel
                                VerticalAlign: =VerticalAlign.Top
                                Width: =115
                                X: =5
                                Y: =5
                                ZIndex: =1

                            icoDecrementMinutes As icon.HorizontalLine:
                                Color: =gblAppStyles.Button.Fill
                                Height: =56
                                Icon: =Icon.HorizontalLine
                                OnSelect: =Select(btnDecrementMinutesSpent)
                                Width: =30
                                X: =47
                                Y: =27
                                ZIndex: =2

            btnConfirmTimeSpent As button:
                BorderColor: =gblAppStyles.Button.BorderColor
                BorderStyle: =gblAppStyles.Button.BorderStyle
                BorderThickness: =gblAppStyles.Button.BorderThickness
                Color: =gblAppStyles.Button.FontColor
                Fill: =gblAppStyles.Button.Fill
                FocusedBorderColor: =gblAppStyles.FocusBorderColor
                FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                Font: =gblAppStyles.Button.Font
                FontWeight: =gblAppStyles.Button.FontWeight
                OnSelect: |-
                    =With(
                        {locAdjustedTimeSpent: Value(txtTimeSpentHours.Text) + (Value(txtTimeSpentMinutes.Text) / 60)},
                        If(
                            CurrentTimeSpent <> locAdjustedTimeSpent,
                            IfError(
                                // try:
                                Patch(
                                    // insert a new journal line for each adjustment to time spent
                                    // which increments with a delta of the previous- and new time spent
                                    'Asset management work order job hour consumption lines (mserp)',
                                    Defaults('Asset management work order job hour consumption lines (mserp)'),
                                    {
                                        'Company Code': gblAppCache.UserActiveWorker.'Company Code',
                                        'Personnel number': gblAppCache.UserActiveWorker.'Personnel number',
                                        'Work order': WorkOrderJob.'Work order',
                                        'Line number (mserp_workorderjobnumber)': WorkOrderJob.'Line number',
                                        Hours: locAdjustedTimeSpent - CurrentTimeSpent
                                    }
                                ),
                                // catch:
                                Notify(
                                    Coalesce(
                                        Match(
                                            FirstError.Details.HttpResponse,
                                            """code"":""(?<code>[^""]*)"",""message"":""(?<message>[^""]*)"
                                        ).message,
                                        T.Error_TimeConsumptionAdjustmentUpdateGenericFailureLabel
                                    ),
                                    NotificationType.Error
                                ),
                                // on success:
                                Back()
                            )
                        );
                        
                    )
                PressedColor: =gblAppStyles.Button.PressedColor
                PressedFill: =gblAppStyles.Button.PressedFill
                RadiusBottomLeft: =Self.RadiusTopLeft
                RadiusBottomRight: =Self.RadiusTopLeft
                RadiusTopLeft: =gblAppStyles.Button.BorderRadius
                RadiusTopRight: =Self.RadiusTopLeft
                Size: =gblAppStyles.Button.FontSize
                Text: =T.ConfirmButtonLabel
                Width: =200
                X: =Parent.Width / 2 - Self.Width / 2
                Y: =Parent.Height - Self.Height - 16
                ZIndex: =2

