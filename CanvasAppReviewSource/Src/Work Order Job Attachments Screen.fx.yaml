"'Work Order Job Attachments Screen' As screen":
    Fill: =gblAppColors.Background
    OnVisible: =Set(gblPreviousScreen, Self)

    galJobAttachments As gallery.galleryVertical:
        '#CopilotOverlayLabel': ="Filtered"
        DelayItemLoading: =true
        Height: =Parent.Height - Self.Y
        Items: |-
            =Filter(
                'Asset maintenance work order line attachment entity (mserp)',
                mserp_dataareaid = Job.mserp_dataareaid,
                mserp_workorderid = Job.mserp_workorderid,
                mserp_linenumber = Job.mserp_linenumber
            )
        Layout: =Layout.Vertical
        LoadingSpinner: =LoadingSpinner.Controls
        OnSelect: |-
            =If(
                // Is URL
                IsMatch(
                    ThisItem.Note,
                    "^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:\/?#[\]@!\$&'\(\)\*\+,;=. %]+$"
                ),
                    Launch(ThisItem.Note),
                // Is Image
                ThisItem.'File type' in [
                    "png",
                    "bmp",
                    "jpeg",
                    "jpg",
                    "gif"
                ],
                    With(
                        {
                            locAttachmentData: LookUp(
                                'Asset maintenance work order line attachment entity (mserp)',
                                'Company Code' = ThisItem.'Company Code'
                                And 'Work order' = ThisItem.'Work order'
                                And 'Line number' = ThisItem.'Line number'
                                And Type = ThisItem.Type
                                And 'Original file name' = ThisItem.'Original file name'
                                And AttachedDateTime = DateAdd(ThisItem.AttachedDateTime, -TimeZoneOffset(ThisItem.AttachedDateTime), TimeUnit.Minutes)
                            ).Bitmap
                        },
                        UpdateContext({varSelectedImage: $"data:application/octet-stream;base64,{locAttachmentData}"})
                    ),
                // Is PDF
                ThisItem.'File type' = "pdf",
                    With(
                        {
                            locAttachmentData: LookUp(
                                'Asset maintenance work order line attachment entity (mserp)',
                                'Company Code' = ThisItem.'Company Code'
                                And 'Work order' = ThisItem.'Work order'
                                And 'Line number' = ThisItem.'Line number'
                                And Type = ThisItem.Type
                                And 'Original file name' = ThisItem.'Original file name'
                                And AttachedDateTime = DateAdd(ThisItem.AttachedDateTime, -TimeZoneOffset(ThisItem.AttachedDateTime), TimeUnit.Minutes)
                            ).Bitmap
                        },
                        UpdateContext({varSelectedPdf: $"data:application/octet-stream;base64,{locAttachmentData}"})
                    ),
                // else:
                Trace(
                    "Attempted viewing an unsupported attachment type",
                    TraceSeverity.Information,
                    {attachmentType: ThisItem.Type}
                );
                Notify(
                    Substitute(
                        T.AttachmentTypeNotSupportedForViewingLabel,
                        "{AttachmentTypeName}",
                        ThisItem.Type
                    )
                );
                
            )
        ShowScrollbar: =false
        TemplatePadding: =0
        TemplateSize: =96
        Visible: |-
            =Not (IsEmpty(galJobAttachments.AllItems)) And With(
                {locFirstAttachment: First(galJobAttachments.AllItems)},
                locFirstAttachment.mserp_dataareaid = Job.mserp_dataareaid
                And locFirstAttachment.mserp_workorderid = Job.mserp_workorderid
                And locFirstAttachment.mserp_linenumber = Job.mserp_linenumber
            )
        Width: =Parent.Width
        Y: =cmpHeaderWOJAS.Height
        ZIndex: =1

        shpBottomLineWOJAS As rectangle:
            Fill: =RGBA(209, 209, 209, 1)
            Height: =1
            OnSelect: =Select(Parent)
            Width: =Parent.TemplateWidth
            Y: =Parent.TemplateHeight - 1
            ZIndex: =1

        conJobAttachmentsHorizontal As groupContainer.horizontalAutoLayoutContainer:
            Height: =Parent.TemplateHeight
            LayoutAlignItems: =LayoutAlignItems.Stretch
            LayoutJustifyContent: =LayoutJustifyContent.SpaceBetween
            LayoutMode: =LayoutMode.Auto
            Width: =Parent.TemplateWidth
            ZIndex: =4

            conJobAttachmentDetails As groupContainer.verticalAutoLayoutContainer:
                AlignInContainer: =AlignInContainer.SetByContainer
                FillPortions: =0
                LayoutAlignItems: =LayoutAlignItems.Stretch
                LayoutDirection: =LayoutDirection.Vertical
                LayoutJustifyContent: =LayoutJustifyContent.Center
                LayoutMinHeight: =50
                LayoutMinWidth: =200
                LayoutMode: =LayoutMode.Auto
                Width: =Parent.Width
                ZIndex: =1

                lblJobAttachmentDescription As label:
                    Color: =gblAppColors.Accent
                    Font: =gblAppStyles.CommonFont
                    FontWeight: =FontWeight.Semibold
                    Height: =50
                    OnSelect: =Select(galJobAttachments)
                    PaddingLeft: =16
                    PaddingRight: =16
                    Size: =gblAppStyles.FontSize_Medium
                    Text: =ThisItem.mserp_attachmentdescription
                    Width: =50
                    Wrap: =false
                    ZIndex: =1

                lblJobAttachmentType As label:
                    Color: =gblAppColors.AccentInfo
                    Font: =gblAppStyles.CommonFont
                    FontWeight: =FontWeight.Semibold
                    Height: =50
                    OnSelect: =Select(galJobAttachments)
                    PaddingLeft: =16
                    PaddingRight: =16
                    Size: =gblAppStyles.FontSize_Medium
                    Text: |-
                        =With(
                            {
                                locAttachmentTypeLocalizationString: Substitute(
                                    T.AttachmentDetailLabel,
                                    "{AttachmentTypeName}",
                                    ThisItem.mserp_documentattachmenttypecode
                                )
                            },
                            If(
                                // Is URL
                                IsMatch(
                                    ThisItem.mserp_notes,
                                    "^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:\/?#[\]@!\$&'\(\)\*\+,;=. %]+$"
                                ),
                                    Substitute(
                                        locAttachmentTypeLocalizationString,
                                        "{Details}",
                                        ThisItem.mserp_notes
                                    ),
                                // Is file-type
                                Not IsBlank(ThisItem.mserp_originalfilename),
                                    Substitute(
                                        locAttachmentTypeLocalizationString,
                                        "{Details}",
                                        ThisItem.mserp_originalfilename
                                    ),
                                // else:
                                ThisItem.mserp_documentattachmenttypecode
                            )
                        )
                    Width: =50
                    Wrap: =false
                    ZIndex: =2

        shpClickSurfaceWOJAS As rectangle:
            Fill: =RGBA(0, 0, 0, 0)
            FocusedBorderColor: =gblAppStyles.FocusBorderColor
            FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
            Height: =Parent.TemplateHeight - 2 * gblAppStyles.FocusBorderThickness
            OnSelect: |-
                =// Containers do not support OnSelect override
                // and catches user clicks, we need this surface to negate that problem.
                Select(Parent)
            TabIndex: =0
            Width: =Parent.TemplateWidth - 2 * gblAppStyles.FocusBorderThickness
            X: =gblAppStyles.FocusBorderThickness
            Y: =gblAppStyles.FocusBorderThickness
            ZIndex: =6

    cmpHeaderWOJAS As SubScreenHeader:
        BackButtonAccessibleLabel: =T.BackButtonAccessibleLabel
        Title: =T.AttachmentsLabel
        ZIndex: =2

    imgJobAttachmentFullScreenImage As image:
        Fill: =RGBA(0, 0, 0, 0.15)
        Height: =Parent.Height
        Image: =varSelectedImage
        OnSelect: |-
            =UpdateContext({varSelectedImage:Blank()})
        TabIndex: =0
        Visible: =varSelectedImage <> Blank()
        Width: =Parent.Width
        ZIndex: =3

    pdfJobAttachmentViewer As pdfViewer:
        BorderColor: =RGBA(0, 0, 0, 1)
        Document: =varSelectedPdf
        Fill: =RGBA(0, 0, 0, 0.5)
        Height: =Parent.Height
        ShowControls: =true
        Visible: =varSelectedPdf <> Blank()
        Width: =Parent.Width
        ZIndex: =4

    btnClosePdfViewer As button:
        BorderColor: =gblAppStyles.Button.BorderColor
        BorderStyle: =gblAppStyles.Button.BorderStyle
        BorderThickness: =gblAppStyles.Button.BorderThickness
        Color: =gblAppStyles.Button.FontColor
        Fill: =gblAppStyles.Button.Fill
        FocusedBorderColor: =gblAppStyles.FocusBorderColor
        FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
        Font: =gblAppStyles.Button.Font
        FontWeight: =gblAppStyles.Button.FontWeight
        Height: =32
        OnSelect: |-
            =UpdateContext({varSelectedPdf:Blank()})
        PaddingBottom: =0
        PaddingLeft: =0
        PaddingRight: =0
        PaddingTop: =0
        PressedColor: =gblAppStyles.Button.PressedColor
        PressedFill: =gblAppStyles.Button.PressedFill
        RadiusBottomLeft: =Self.RadiusTopLeft
        RadiusBottomRight: =Self.RadiusTopLeft
        RadiusTopLeft: =16
        RadiusTopRight: =Self.RadiusTopLeft
        Size: =gblAppStyles.Button.FontSize
        Text: ="X"
        Visible: =pdfJobAttachmentViewer.Visible
        Width: =32
        X: =Parent.Width - Self.Width - (16 + 6)
        Y: =Self.Height + 32
        ZIndex: =5

