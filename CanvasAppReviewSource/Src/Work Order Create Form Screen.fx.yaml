"'Work Order Create Form Screen' As screen":
    Fill: =gblAppColors.Background
    OnVisible: |
        =Clear(locWOAttachments);
        IfError(
            //try
            UpdateContext(
                {
                    locWOCount: CountRows(
                        GroupBy(
                            Filter(
                                'Asset management work order jobs V2 (mserp)',
                                'Company Code' = locAsset.'Company Code',
                                Asset = locAsset.'Asset (mserp_maintenanceassetid)',
                                'Asset management work orders V2'.Active = 'NoYes (mserp)'.Yes
                            ),
                            'Work order',
                            WorkOrders
                        )
                    )
                }
            ),
            //catch
            UpdateContext({locWOCount: Blank()});
            Notify(
                Match(
                    FirstError.Details.HttpResponse,
                    "\""code"":""(?<code>[^""]*)"",""message"":""(?<message>[^""]*)"
                ).message,
                NotificationType.Error
            );
            
        );
        IfError(
            UpdateContext(
                {
                    locMRCount: With(
                        {
                            locMaintenanceRequestsToCount: Filter(
                                'Maintenance Requests',
                                Asset = locAsset.'Asset (mserp_maintenanceassetid)',
                                'Company Code' = locAsset.'Company Code',
                                Active = 'NoYes (mserp)'.Yes
                            )
                        },
                        CountRows(locMaintenanceRequestsToCount)
                    )
                }
            ),
            //catch
            UpdateContext({locMRCount: Blank()});
            Notify(
                Match(
                    FirstError.Details.HttpResponse,
                    "\""code"":""(?<code>[^""]*)"",""message"":""(?<message>[^""]*)"
                ).message,
                NotificationType.Error
            );
            
        );
        
        Set(gblPreviousScreen, Self)

    conVerticalCreateWorkOrder As groupContainer.verticalAutoLayoutContainer:
        Height: =Parent.Height - btnCreateWOSubmit.Height -16
        LayoutDirection: =LayoutDirection.Vertical
        LayoutMode: =LayoutMode.Auto
        LayoutOverflowY: =LayoutOverflow.Scroll
        PaddingBottom: =10
        Width: =Parent.Width
        ZIndex: =1

        conCreateWOHeader As groupContainer.manualLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            FillPortions: =0
            Height: =52
            LayoutMinHeight: =100
            LayoutMinWidth: =250
            Width: =Parent.Width
            ZIndex: =1

            lblCreateWOHeader As label:
                Align: =Align.Center
                Color: =RGBA(255, 255, 255, 1)
                Fill: =gblAppStyles.Header.Fill
                Font: =gblAppStyles.CommonFont
                FontWeight: =gblAppStyles.Header.FontWeight
                Height: =54
                PaddingLeft: =icoCreateWOBackButton.Width
                PaddingRight: =icoCreateWOBackButton.Width
                Size: =gblAppStyles.Header.FontSize
                Text: |-
                    =//pal-disable PAL004
                    locAsset.mserp_maintenanceassetid
                Width: =Parent.Width
                Wrap: =false
                X: =
                ZIndex: =4

            icoCreateWOBackButton As icon.ChevronLeft:
                AccessibleLabel: =T.BackButtonAccessibleLabel
                Color: =Color.White
                FocusedBorderColor: =gblAppStyles.FocusBorderColor
                FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                Height: =Parent.Height
                Icon: =Icon.ChevronLeft
                OnSelect: |+
                    =Concurrent(
                        Reset(cmpNewWorkOrderDescription),
                        Reset(cmpNewWorkOrderNotes),
                        Reset(drpNewWorkOrderServiceLevel),
                        Reset(drpNewWorkOrderType)
                    );
                    Back();
                    
                PaddingBottom: =16
                PaddingLeft: =16
                PaddingRight: =16
                PaddingTop: =16
                TabIndex: =0
                Width: =56
                X: =2
                Y: =2
                ZIndex: =5

        conCreateWOSubHeader As groupContainer.horizontalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            Fill: =gblAppStyles.Header.Fill
            FillPortions: =0
            Height: =If(Self.Width <= conCreateWOSubHeader.LayoutMinWidth ,gblAppStyles.Pills.Height * 2 + 20 ,62)
            LayoutAlignItems: =LayoutAlignItems.Center
            LayoutDirection: =If(Self.Width <= conCreateWOSubHeader.LayoutMinWidth ,LayoutDirection.Vertical,LayoutDirection.Horizontal)
            LayoutGap: =10
            LayoutMinHeight: =100
            LayoutMinWidth: =340
            LayoutMode: =LayoutMode.Auto
            PaddingLeft: =16
            PaddingRight: =16
            Width: =Parent.Width
            ZIndex: =2

            conExistingWorkOrdersWOCFS As groupContainer.manualLayoutContainer:
                AlignInContainer: =AlignInContainer.SetByContainer
                FillPortions: =0
                Height: =42
                LayoutMinHeight: =100
                LayoutMinWidth: =100
                Width: =btnExistingWorkOrdersWOCFS.Width + 4
                ZIndex: =1

                btnExistingWorkOrdersWOCFS As button:
                    BorderThickness: =0
                    Color: =gblAppStyles.Pills.FontColor
                    DisabledColor: =gblAppStyles.Pills.DisabledColor
                    DisabledFill: =gblAppStyles.Pills.DisabledFill
                    DisplayMode: |-
                        =If(
                            locWOCount > 0,
                            DisplayMode.Edit,
                            DisplayMode.Disabled
                        )
                    Fill: =gblAppStyles.Pills.Fill
                    FocusedBorderColor: =gblAppStyles.FocusBorderColor
                    FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                    Font: =gblAppStyles.Pills.Font
                    FontWeight: =gblAppStyles.Pills.FontWeight
                    Height: =gblAppStyles.Pills.Height
                    OnSelect: |-
                        =Navigate(
                            'Maintenance Request Work Order List Screen',
                            ScreenTransition.None,
                            {locCreateMode: locCreateMode, locAsset: locAsset}
                        )
                    PaddingLeft: =Len(Self.Text)*1.2
                    PaddingRight: =0
                    PressedBorderColor: =
                    PressedColor: =gblAppStyles.Pills.PressedColor
                    PressedFill: =gblAppStyles.Pills.PressedFill
                    RadiusBottomLeft: =1000
                    RadiusBottomRight: =1000
                    RadiusTopLeft: =1000
                    RadiusTopRight: =1000
                    Size: =gblAppStyles.FontSize_Medium
                    Text: |-
                        =If(
                            IsBlankOrError(locWOCount),
                            T.MaintenanceWorkOrdersExistingLabel,
                            Substitute(
                                T.MaintenanceWorkOrdersExistingCountLabel,
                                "{ExistingWorkOrdersCount}",
                                If(
                                    locWOCount > 99,
                                    "99+",
                                    locWOCount
                                )
                            )
                        )
                    X: =1
                    Y: =2
                    ZIndex: =1

                icoExistingWorkOrdersWOCFS As icon.DetailList:
                    Color: =gblAppColors.AccentInfo3
                    Fill: =RGBA(0,0,0,0)
                    Height: =17
                    Icon: =Icon.DetailList
                    OnSelect: =Select(btnExistingWorkOrdersWOCFS);
                    PaddingRight: =5
                    PressedFill: =gblAppStyles.Pills.PressedFill
                    Width: =29
                    X: =7
                    Y: =11
                    ZIndex: =2

            conExistingMaintenanceRequestsWOCFS As groupContainer.manualLayoutContainer:
                AlignInContainer: =AlignInContainer.SetByContainer
                FillPortions: =0
                Height: =42
                LayoutMinHeight: =100
                LayoutMinWidth: =100
                Width: =btnExistingMaintenanceRequestsWOCFS.Width + 4
                ZIndex: =2

                btnExistingMaintenanceRequestsWOCFS As button:
                    BorderThickness: =0
                    Color: =gblAppStyles.Pills.FontColor
                    DisabledColor: =gblAppStyles.Pills.DisabledColor
                    DisabledFill: =gblAppStyles.Pills.DisabledFill
                    DisplayMode: |-
                        =If(
                            locMRCount > 0,
                            DisplayMode.Edit,
                            DisplayMode.Disabled
                        )
                    Fill: =gblAppStyles.Pills.Fill
                    FocusedBorderColor: =gblAppStyles.FocusBorderColor
                    FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                    Font: =gblAppStyles.Pills.Font
                    FontWeight: =gblAppStyles.Pills.FontWeight
                    Height: =gblAppStyles.Pills.Height
                    OnSelect: |-
                        =Navigate(
                            'Maintenance Requests List Screen',
                            ScreenTransition.None,
                            {locCreateMode: locCreateMode, locAsset: locAsset}
                        )
                    PaddingLeft: =Len(Self.Text)*1.5
                    PaddingRight: =0
                    PressedBorderColor: =
                    PressedColor: =gblAppStyles.Pills.PressedColor
                    PressedFill: =gblAppStyles.Pills.PressedFill
                    RadiusBottomLeft: =1000
                    RadiusBottomRight: =1000
                    RadiusTopLeft: =1000
                    RadiusTopRight: =1000
                    Size: =gblAppStyles.Pills.FontSize
                    Text: |-
                        =If(
                            IsBlankOrError(locMRCount),
                            T.MaintenanceRequestsExistingLabel,
                            Substitute(
                                T.MaintenanceRequestsExistingCountLabel,
                                "{ExistingRequestsCount}",
                                If(
                                    locMRCount > 99,
                                    "99+",
                                    locMRCount
                                )
                            )
                        )
                    Width: =135
                    X: =2
                    Y: =2
                    ZIndex: =1

                icoExistingMaintenanceRequestsWOCFS As icon.DetailList:
                    Color: |-
                        =ColorValue("#3280AB")
                    Fill: =RGBA(0,0,0,0)
                    Height: =17
                    Icon: =Icon.ToolsWrench
                    OnSelect: =Select(btnExistingMaintenanceRequestsWOCFS)
                    PaddingRight: =5
                    PressedFill: =gblAppStyles.Pills.PressedFill
                    Width: =29
                    X: =7
                    Y: =11
                    ZIndex: =2

        conCreateWorkOrderForm As groupContainer.verticalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            LayoutAlignItems: =LayoutAlignItems.Stretch
            LayoutDirection: =LayoutDirection.Vertical
            LayoutGap: =16
            LayoutJustifyContent: =LayoutJustifyContent.SpaceBetween
            LayoutMinHeight: =100
            LayoutMinWidth: =250
            LayoutMode: =LayoutMode.Auto
            LayoutOverflowY: =LayoutOverflow.Scroll
            PaddingBottom: =16
            PaddingLeft: =gblAppStyles.Padding.Left
            PaddingRight: =gblAppStyles.Padding.Right
            PaddingTop: =16
            Width: =Parent.Width
            ZIndex: =3

            lblCreateWorkOrderIntro As label:
                Color: =gblAppColors.PrimaryText
                Font: =gblAppStyles.CommonFont
                Height: =25
                PaddingBottom: =0
                PaddingTop: =0
                Size: =gblAppStyles.FontSize_Large
                Text: =T.WOCreationInstructionLabel
                Width: =Parent.Width
                ZIndex: =1

            cmpNewWorkOrderDescription As TextInputWithLabel:
                AccessibleLabel: =T.WODescriptionAccessibleLabel
                backgroundColor: =gblAppColors.Neutral
                dividerColor: =gblAppColors.AccentLink
                Height: =54
                labelColor: =gblAppStyles.Label.FontColor
                labelFontSize: =gblAppStyles.Label.FontSize
                labelText: =T.WODescriptionHeaderLabel
                LayoutMinHeight: =40
                LayoutMinWidth: =11
                MaxLength: =60
                multiLine: =false
                textFont: =gblAppStyles.Label.Font
                textFontSize: =gblAppStyles.FontSize_Large
                Width: =Parent.Width - Parent.PaddingLeft*2
                Y: =16
                ZIndex: =2

            cmpNewWorkOrderNotes As TextInputWithLabel:
                AccessibleLabel: =T.WONotesAccessibleLabel
                backgroundColor: =gblAppColors.Neutral
                dividerColor: =gblAppColors.AccentLink
                Height: =108
                labelColor: =gblAppStyles.Label.FontColor
                labelFontSize: =gblAppStyles.Label.FontSize
                labelText: =T.WONotesHeaderLabel
                LayoutMinHeight: =50
                LayoutMinWidth: =10
                MaxLength: =Blank()
                textColor: =gblAppColors.PrimaryText
                textFont: =gblAppStyles.DefaultText.Font
                textFontSize: =gblAppStyles.FontSize_Large
                Width: =Parent.Width - Parent.PaddingLeft*2
                Y: =16
                ZIndex: =3

            conNewWorkOrderServiceLevel As groupContainer.manualLayoutContainer:
                AlignInContainer: =AlignInContainer.SetByContainer
                Fill: =gblAppColors.Neutral
                FillPortions: =0
                Height: =72
                LayoutMinHeight: =60
                LayoutMinWidth: =250
                PaddingBottom: =(conNewWorkOrderServiceLevel.Height - lblNewWorkOrderServiceLevel.Height - drpNewWorkOrderServiceLevel.Height)/2
                PaddingTop: =(conNewWorkOrderServiceLevel.Height - lblNewWorkOrderServiceLevel.Height - drpNewWorkOrderServiceLevel.Height)/2
                Width: =Parent.Width - Parent.PaddingLeft*2
                ZIndex: =5

                shpNewWorkOrderServiceLevelBottomBorder As rectangle:
                    Fill: =gblAppColors.AccentLink
                    Height: =2
                    Width: =Parent.Width
                    Y: =Parent.Height - Self.Height
                    ZIndex: =1

                drpNewWorkOrderServiceLevel As dropdown:
                    AccessibleLabel: =T.WOServiceLevelAccessibleLabel
                    BorderThickness: =0
                    ChevronBackground: =RGBA(255, 255, 255, 1)
                    ChevronFill: =gblAppColors.Accent
                    Color: =gblAppColors.Accent
                    Default: =locDefaultServiceLevel
                    FocusedBorderColor: =gblAppStyles.FocusBorderColor
                    FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                    Font: =gblAppStyles.CommonFont
                    Height: =32
                    Items: =Filter('Work Order Service Levels', mserp_dataareaid = locAsset.mserp_dataareaid)
                    PaddingLeft: =8
                    PressedColor: =Self.Color
                    PressedFill: =gblAppColors.Neutral
                    SelectionFill: =gblAppColors.Accent
                    Size: =gblAppStyles.FontSize_Large
                    Width: =Parent.Width-8
                    Y: =27
                    ZIndex: =2

                lblNewWorkOrderServiceLevel As label:
                    Color: =gblAppStyles.Label.FontColor
                    Font: =gblAppStyles.Label.Font
                    Height: =27
                    PaddingLeft: =8
                    Size: =gblAppStyles.Label.FontSize
                    Text: =T.ServiceLevelLabel
                    Width: =225
                    ZIndex: =3

            conNewWorkOrderType As groupContainer.manualLayoutContainer:
                AlignInContainer: =AlignInContainer.SetByContainer
                Fill: =gblAppColors.Neutral
                FillPortions: =0
                Height: =72
                LayoutMinHeight: =60
                LayoutMinWidth: =250
                PaddingLeft: =8
                PaddingRight: =10
                Width: =Parent.Width - Parent.PaddingLeft*2
                ZIndex: =6

                shpNewWorkOrderTypeBottomBorder As rectangle:
                    Fill: =gblAppColors.AccentLink
                    Height: =2
                    Width: =Parent.Width
                    Y: =Parent.Height - Self.Height
                    ZIndex: =1

                drpNewWorkOrderType As dropdown:
                    AccessibleLabel: =T.WOTypeAccessibleLabel
                    BorderThickness: =0
                    ChevronBackground: =RGBA(255, 255, 255, 1)
                    ChevronFill: =gblAppColors.Accent
                    Color: =gblAppColors.Accent
                    Default: =locDefaultWorkOrderType
                    FocusedBorderColor: =gblAppStyles.FocusBorderColor
                    FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                    Font: =gblAppStyles.CommonFont
                    Height: =31
                    Items: |-
                        =Filter(
                            'Asset management work order types (mserp)',
                            mserp_dataareaid = locAsset.mserp_dataareaid
                        )
                    PaddingLeft: =8
                    PressedColor: =Self.Color
                    PressedFill: =gblAppColors.Neutral
                    SelectionFill: =gblAppColors.Accent
                    Size: =gblAppStyles.FontSize_Large
                    Width: =Parent.Width-8
                    Y: =27
                    ZIndex: =2

                lblNewWorkOrderType As label:
                    Color: =gblAppStyles.Label.FontColor
                    Font: =gblAppStyles.Label.Font
                    Height: =27
                    PaddingLeft: =8
                    Size: =gblAppStyles.Label.FontSize
                    Text: =T.WorkOrderTypeLabel
                    Width: =Parent.Width
                    ZIndex: =3

            grpAddAttachmentToNewWorkOrder As group:
                Height: =5
                LayoutMinHeight: =5
                LayoutMinWidth: =5
                Width: =5
                X: =40
                Y: =40
                ZIndex: =7

                imgAddAttachmentToNewWorkOrder As image:
                    ApplyEXIFOrientation: =false
                    Height: =Self.Width
                    Image: =If(!IsBlank(btnAddAttachmentToNewWorkOrder.Media), btnAddAttachmentToNewWorkOrder.Media)
                    LayoutMinHeight: =50
                    Visible: =false
                    Width: =Min(300,Parent.Width -16*2)
                    X: =btnAddAttachmentToNewWorkOrder.X
                    Y: =btnAddAttachmentToNewWorkOrder.Y
                    ZIndex: =7

                btnAddAttachmentToNewWorkOrder As addMedia:
                    AccessibleLabel: =T.WOAddImageAccessibleLabel
                    BorderColor: =gblAppColors.Primary
                    ChangePictureText: =T.WOAddImageButtonLabel
                    Color: =gblAppColors.Primary
                    Fill: =gblAppColors.Background
                    FocusedBorderColor: =gblAppStyles.FocusBorderColor
                    FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                    Font: =gblAppStyles.CommonFont
                    Height: =gblAppStyles.Button.Height
                    LayoutMinHeight: =50
                    LayoutMinWidth: =100
                    OnSelect: |-
                        =UpdateContext( {locImageData: JSON( imgAddAttachmentToNewWorkOrder.Image,JSONFormat.IncludeBinaryData )});
                        UpdateContext( {locImageBase64: Mid(locImageData, Find(",", locImageData)+1, Len(locImageData)-Find(",", locImageData)-1)});
                        UpdateContext( {locFileExtension: Mid(locImageData, Find("/", locImageData)+1, Find(";base64,", locImageData) - Find("/", locImageData)-1)});
                        
                        If(
                            Len(locImageBase64) >= DataSourceInfo(
                                'Asset maintenance work order line attachment entity (mserp)',
                                DataSourceInfo.MaxLength,
                                Bitmap
                            ),
                            Notify(T.Error_PhotoTooLargeToAttach, NotificationType.Warning),
                            Collect(
                                locWOAttachments,
                                {
                                    Value: btnAddAttachmentToNewWorkOrder.Media,
                                    ImageData: locImageData,
                                    ImageBase64: locImageBase64,
                                    FileExtension: locFileExtension,
                                    FileName: GUID() & "." & locFileExtension
                                }
                            )
                        )
                    Padding: =10
                    Size: =gblAppStyles.Button.FontSize
                    Text: =T.WOAddImageButtonLabel
                    Width: =Min(300,Parent.Width -16*2)
                    X: =40
                    Y: =40
                    ZIndex: =12

            conNewWorkOrderJobType As groupContainer.manualLayoutContainer:
                AlignInContainer: =AlignInContainer.SetByContainer
                Fill: =gblAppColors.Neutral
                FillPortions: =0
                Height: =72
                LayoutMinHeight: =60
                LayoutMinWidth: =250
                PaddingLeft: =8
                PaddingRight: =10
                Width: =Parent.Width - Parent.PaddingLeft*2
                ZIndex: =8

                shpNewWorkOrderJobTypeBottomBorder As rectangle:
                    Fill: =gblAppColors.AccentLink
                    Height: =2
                    Width: =Parent.Width
                    Y: =Parent.Height - Self.Height
                    ZIndex: =1

                drpNewWorkOrderJobType As dropdown:
                    AccessibleLabel: =T.WOJobTypeAccessibleLabel
                    BorderThickness: =0
                    ChevronBackground: =RGBA(255, 255, 255, 1)
                    ChevronFill: =gblAppColors.Accent
                    Color: =gblAppColors.Accent
                    Default: =locDefaultWorkOrderType
                    FocusedBorderColor: =gblAppStyles.FocusBorderColor
                    FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                    Font: =gblAppStyles.CommonFont
                    Height: =31
                    Items: |-
                        =Filter(
                            'Asset management maintenance job types (mserp)',
                            mserp_dataareaid = locAsset.mserp_dataareaid
                        )
                    PaddingLeft: =8
                    PressedColor: =Self.Color
                    PressedFill: =gblAppColors.Neutral
                    SelectionFill: =gblAppColors.Accent
                    Size: =gblAppStyles.FontSize_Large
                    Width: =Parent.Width-8
                    Y: =27
                    ZIndex: =2

                lblNewWorkOrderJobType As label:
                    Color: =gblAppStyles.Label.FontColor
                    Font: =gblAppStyles.Label.Font
                    Height: =27
                    PaddingLeft: =8
                    Size: =gblAppStyles.Label.FontSize
                    Text: =T.WOJobType
                    Width: =Parent.Width
                    ZIndex: =3

            conNewWorkOrderJobTypeVariant As groupContainer.manualLayoutContainer:
                AlignInContainer: =AlignInContainer.SetByContainer
                Fill: =gblAppColors.Neutral
                FillPortions: =0
                Height: =72
                LayoutMinHeight: =60
                LayoutMinWidth: =250
                PaddingLeft: =8
                PaddingRight: =10
                Visible: =Not IsBlank(drpNewWorkOrderJobTypeVariant.Selected)
                Width: =Parent.Width - Parent.PaddingLeft*2
                ZIndex: =9

                shpNewWorkOrderJobTypeVariantBottomBorder As rectangle:
                    Fill: =gblAppColors.AccentLink
                    Height: =2
                    Width: =Parent.Width
                    Y: =Parent.Height - Self.Height
                    ZIndex: =1

                drpNewWorkOrderJobTypeVariant As dropdown:
                    AccessibleLabel: =T.WOJobTypeVariantAccessibleLabel
                    BorderThickness: =0
                    ChevronBackground: =RGBA(255, 255, 255, 1)
                    ChevronFill: =gblAppColors.Accent
                    Color: =gblAppColors.Accent
                    Default: =locDefaultWorkOrderType
                    FocusedBorderColor: =gblAppStyles.FocusBorderColor
                    FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
                    Font: =gblAppStyles.CommonFont
                    Height: =31
                    Items: |-
                        =Filter(
                            'Asset management maintenance job type variants (mserp)',
                            mserp_dataareaid = locAsset.mserp_dataareaid,
                            mserp_jobtypeid = drpNewWorkOrderJobType.Selected.mserp_jobtypeid
                        )
                    PaddingLeft: =8
                    PressedColor: =Self.Color
                    PressedFill: =gblAppColors.Neutral
                    SelectionFill: =gblAppColors.Accent
                    Size: =gblAppStyles.FontSize_Large
                    Width: =Parent.Width-8
                    Y: =27
                    ZIndex: =2

                lblNewWorkOrderJobTypeVariant As label:
                    Color: =gblAppStyles.Label.FontColor
                    Font: =gblAppStyles.Label.Font
                    Height: =27
                    PaddingLeft: =8
                    Size: =gblAppStyles.Label.FontSize
                    Text: =T.WOJobTypeVariant
                    Width: =Parent.Width
                    ZIndex: =3

            tglNewWorkOrderScheduleImmediately As toggleSwitch:
                AccessibleLabel: =If(Self.Value, T.WOAutoScheduleOffAccessibleLabel, T.WOAutoScheduleOnAccessibleLabel)
                FalseText: =T.WOAutoScheduleOff
                Font: =gblAppStyles.CommonFont
                Size: =gblAppStyles.FontSize_Large
                TextPosition: =TextPosition.Left
                TrueText: =T.WOAutoScheduleOn
                ZIndex: =10

            "galNewWorkOrderAttachments As gallery.'BrowseLayout_Horizontal_TwoTextOneImageVariant_ver4.0'":
                '#CopilotOverlayLabel': ="Filtered"
                AccessibleLabel: =T.WOAttachmentsAccessibleLabel
                AlignInContainer: =AlignInContainer.SetByContainer
                Height: =260
                Items: =locWOAttachments
                LayoutMinHeight: =260
                LayoutMinWidth: =300
                TemplatePadding: =0
                TemplateSize: =Min(440, Self.Height - 60)
                Visible: =Not IsEmpty(locWOAttachments)
                ZIndex: =11

                imgAttachmentWOCFS As image:
                    ApplyEXIFOrientation: =false
                    Height: =imgAttachmentWOCFS.Width
                    Image: =ThisItem.Value
                    ImagePosition: =ImagePosition.Stretch
                    OnSelect: =Select(Parent)
                    Width: =Parent.TemplateWidth - 16
                    Y: =1
                    ZIndex: =1

                imgRemoveAttachmentWOCFS As image:
                    AccessibleLabel: =T.RemoveItemIconAccessibleLabel
                    Height: =1
                    Image: =removeImage
                    OnSelect: =Remove(locWOAttachments,ThisItem)
                    PressedFill: =ColorFade(Self.Fill, -30%)
                    Width: =1
                    ZIndex: =2

    btnCreateWOSubmit As button:
        BorderThickness: =0
        Color: =gblAppStyles.Button.FontColor
        Fill: =gblAppStyles.Button.Fill
        FocusedBorderColor: =gblAppStyles.FocusBorderColor
        FocusedBorderThickness: =gblAppStyles.FocusBorderThickness
        Font: =gblAppStyles.CommonFont
        FontWeight: =gblAppStyles.Button.FontWeight
        Height: =gblAppStyles.Button.Height
        OnSelect: |
            =// 1. Create work order
            // 2. Create work order job line on that work order
            // 3. Create any attachments and attach them to the job line
            With(
                {
                    locCreatedWorkOrder: Patch(
                        'Asset management work orders V2 (mserp)',
                        Defaults('Asset management work orders V2 (mserp)'),
                        {
                            Description: cmpNewWorkOrderDescription.Text,
                            'Service level': drpNewWorkOrderServiceLevel.Selected.'Service level',
                            'Work order type': drpNewWorkOrderType.Selected.'Work order type',
                            'Company Code': locAsset.'Company Code',
                            'Customer account':locAsset.'Customer account',
                            'Expected start': DateAdd( // UserTime => UTC
                                Now(),
                                TimeZoneOffset(),
                                TimeUnit.Minutes
                            )
                        }
                    )
                },
                IfError(
                    locCreatedWorkOrder,
                    // on error:
                    With(
                        {
                            locFnOErrorMessage: Match(
                                FirstError.Details.HttpResponse,
                                "\""code"":""(?<code>[^""]*)"",""message"":""(?<message>[^""]*)"
                            ).message
                        },
                        Notify(
                            FirstError.Message,
                            NotificationType.Error
                        );
                        Notify(
                            locFnOErrorMessage,
                            NotificationType.Error
                        );
                        Trace(
                            "Failed creating work order",
                            TraceSeverity.Error,
                            {
                                FnOError: locFnOErrorMessage,
                                ErrorMessage: FirstError.Message
                            }
                        );
                    ),
                    // else:
                    With(
                        {
                            locCreatedWorkOrderJobLine: Patch(
                                'Asset management work order jobs V2 (mserp)',
                                Defaults('Asset management work order jobs V2 (mserp)'),
                                {
                                    'Work order': locCreatedWorkOrder.'Work order',
                                    'Line number': 1,
                                    'Company Code': locCreatedWorkOrder.'Company Code',
                                    Asset: locAsset.'Asset (mserp_maintenanceassetid)',
                                    Description: cmpNewWorkOrderDescription.Text,
                                    'Internal note': cmpNewWorkOrderNotes.Text,
                                    'Maintenance job type': drpNewWorkOrderJobType.Selected.'Maintenance job type',
                                    'Maintenance job type variant': drpNewWorkOrderJobTypeVariant.Selected.'Maintenance job type variant',
                                    'Schedule work order job': If(
                                        tglNewWorkOrderScheduleImmediately.Value,
                                        'NoYes (mserp)'.Yes,
                                        'NoYes (mserp)'.No
                                    )
                                }
                            )
                        },
                        IfError(
                            locCreatedWorkOrderJobLine,
                            // on error:
                            With(
                                {
                                    locFnOErrorMessage: Match(
                                        FirstError.Details.HttpResponse,
                                        "\""code"":""(?<code>[^""]*)"",""message"":""(?<message>[^""]*)"
                                    ).message
                                },
                                Notify(
                                    FirstError.Message,
                                    NotificationType.Error
                                );
                                Notify(
                                    locFnOErrorMessage,
                                    NotificationType.Error
                                );
                                Trace(
                                    "Failed creating work order job line",
                                    TraceSeverity.Error,
                                    {
                                        FnOError: locFnOErrorMessage,
                                        ErrorMessage: FirstError.Message
                                    }
                                );
                            ),
                            // else:
                            With(
                                {
                                    locDocuType: LookUp(
                                        ShowColumns(
                                            Filter(
                                                'Document types (mserp)',
                                                'Company Code' = locCreatedWorkOrder.'Company Code'
                                            ),
                                            ActionClassName,
                                            'Company Code',
                                            Type
                                        ),
                                        mserp_actionclassname = "DocuActionArchive"
                                    ),
                                    locImageBase64: Mid(
                                        locImageData,
                                        Find(
                                            ",",
                                            locImageData
                                        ) + 1,
                                        Len(locImageData) - Find(
                                            ",",
                                            locImageData
                                        ) - 1
                                    ),
                                    locFileExtension: Mid(
                                        locImageData,
                                        Find(
                                            "/",
                                            locImageData
                                        ) + 1,
                                        Find(
                                            ";base64,",
                                            locImageData
                                        ) - Find(
                                            "/",
                                            locImageData
                                        ) - 1
                                    )
                                },
                                If(
                                    IsBlankOrError(locDocuType),
                                    Notify(T.Error_AttachmentCreationFailureFromMissingDocumentTypeConfiguration);
                                    Trace(
                                        "Unable to create attachments as document type configuration is missing",
                                        TraceSeverity.Error,
                                        {LocDocuType: locDocuType}
                                    ),
                                    ForAll(
                                        locWOAttachments As attachment,
                                        Patch(
                                            'Asset maintenance work order line attachment entity (mserp)',
                                            Defaults('Asset maintenance work order line attachment entity (mserp)'),
                                            {
                                                'Company Code': locCreatedWorkOrder.'Company Code',
                                                'Work order': locCreatedWorkOrder.'Work order',
                                                'Line number': 1,
                                                DocumentAttachmentTypeLegalEntityId: locDocuType.mserp_dataareaid,
                                                Type: locDocuType.mserp_id,
                                                Bitmap: attachment.ImageBase64,
                                                'Original file name': attachment.FileName,
                                                Description: attachment.FileName
                                            }
                                        )
                                    );
                                    Clear(locWOAttachments);
                                    Reset(cmpNewWorkOrderDescription);
                                    Reset(cmpNewWorkOrderNotes);
                                    Reset(drpNewWorkOrderServiceLevel);
                                    Reset(drpNewWorkOrderType);
                                    Reset(drpNewWorkOrderJobType);
                                    Reset(drpNewWorkOrderJobTypeVariant);
                                    Reset(tglNewWorkOrderScheduleImmediately);
                                    Navigate(
                                        'Creation Success Screen',
                                        ScreenTransition.None,
                                        {
                                            locHeaderText: lblCreateWOHeader.Text,
                                            locCreatedId: locCreatedWorkOrder.'Work order',
                                            locCreatedType: C.Creation.CreateWorkOrder
                                        }
                                    );
                                )
                            )
                        )
                    )
                )
            );
        Size: =gblAppStyles.Button.FontSize
        Text: =T.SubmitButtonLabel
        Width: =Min(300,Parent.Width -16*2)
        X: =(Parent.Width / 2) - (Self.Width/2)
        Y: =conVerticalCreateWorkOrder.Height
        ZIndex: =2

